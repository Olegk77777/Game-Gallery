#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ .exr —Ñ–∞–π–ª–æ–≤ –≤ .png
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/convert-exr-to-png.sh

echo "üîç –ü–æ–∏—Å–∫ .exr —Ñ–∞–π–ª–æ–≤ –≤ public/gallery/..."

# –°—á–µ—Ç—á–∏–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
count=0

# –ü–æ–∏—Å–∫ –≤—Å–µ—Ö .exr —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ gallery
find public/gallery -name "*.exr" -type f | while read -r exr_file; do
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    png_file="${exr_file%.exr}.png"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ .png —Ñ–∞–π–ª
    if [ -f "$png_file" ]; then
        echo "‚è≠Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç): $png_file"
    else
        echo "üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: $exr_file -> $png_file"
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –≥–∞–º–º–∞-–∫–æ—Ä—Ä–µ–∫—Ü–∏—é –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑ linear –≤ sRGB
        # gamma=0.45 —ç—Ç–æ –æ–±—Ä–∞—Ç–Ω–∞—è –≤–µ–ª–∏—á–∏–Ω–∞ –æ—Ç 2.2 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è sRGB –≥–∞–º–º–∞)
        ffmpeg -i "$exr_file" \
            -vf "eq=gamma=0.45" \
            -pix_fmt rgb24 \
            -y "$png_file" -loglevel error
        
        if [ $? -eq 0 ]; then
            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ: $png_file"
            ((count++))
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: $exr_file"
        fi
    fi
done

echo ""
echo "‚ú® –ì–æ—Ç–æ–≤–æ! –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: $count"
echo ""
echo "‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ src/data/games.json —Å .exr –Ω–∞ .png!"
